import { webSearchTool, Agent, AgentInputItem, Runner, withTrace } from "@openai/agents";
import { z } from "zod";


// Tool definitions
const webSearchPreview = webSearchTool({
  searchContextSize: "medium",
  userLocation: {
    type: "approximate"
  }
})
const ClassifierSchema = z.object({ classification: z.enum(["flight_info", "itinerary"]) });
const FlightAgentSchema = z.object({ title: z.string(), flights: z.array(z.object({ id: z.string(), airline: z.string(), number: z.string(), duration: z.string(), from: z.object({ code: z.string(), city: z.string(), time: z.string() }), to: z.object({ code: z.string(), city: z.string(), time: z.string() }) })) });
const classifier = new Agent({
  name: "Classifier",
  instructions: "You are a helpful travel assistant for classifying whether a message is about an itinerary or a flight.",
  model: "gpt-5-nano",
  outputType: ClassifierSchema,
  modelSettings: {
    reasoning: {
      effort: "low"
    },
    store: true
  }
});

const flightAgent = new Agent({
  name: "Flight Agent",
  instructions: "You are a travel assistant. Recommmend a flight itinerary to go from origin to destination. Use airport codes. Show connection flights.",
  model: "gpt-4.1",
  tools: [
    webSearchPreview
  ],
  outputType: FlightAgentSchema,
  modelSettings: {
    temperature: 1,
    topP: 1,
    maxTokens: 2048,
    store: true
  }
});

const itineraryAgent = new Agent({
  name: "Itinerary Agent",
  instructions: "You are a travel assistant to build a concise itinerary.",
  model: "gpt-4o-mini",
  tools: [
    webSearchPreview
  ],
  modelSettings: {
    temperature: 1,
    topP: 1,
    maxTokens: 2048,
    store: true
  }
});

type WorkflowInput = { input_as_text: string };


// Main code entrypoint
export const runWorkflow = async (workflow: WorkflowInput) => {
  return await withTrace("Travel Agent", async () => {
    const state = {

    };
    const conversationHistory: AgentInputItem[] = [
      { role: "user", content: [{ type: "input_text", text: workflow.input_as_text }] }
    ];
    const runner = new Runner({
      traceMetadata: {
        __trace_source__: "agent-builder",
        workflow_id: "wf_690b6ab4dab881908607835343823178039baa053f6f52a6"
      }
    });
    const classifierResultTemp = await runner.run(
      classifier,
      [
        ...conversationHistory
      ]
    );
    conversationHistory.push(...classifierResultTemp.newItems.map((item) => item.rawItem));

    if (!classifierResultTemp.finalOutput) {
        throw new Error("Agent result is undefined");
    }

    const classifierResult = {
      output_text: JSON.stringify(classifierResultTemp.finalOutput),
      output_parsed: classifierResultTemp.finalOutput
    };
    if (classifierResult.output_parsed.classification == "flight_info") {
      const flightAgentResultTemp = await runner.run(
        flightAgent,
        [
          ...conversationHistory
        ]
      );
      conversationHistory.push(...flightAgentResultTemp.newItems.map((item) => item.rawItem));

      if (!flightAgentResultTemp.finalOutput) {
          throw new Error("Agent result is undefined");
      }

      const flightAgentResult = {
        output_text: JSON.stringify(flightAgentResultTemp.finalOutput),
        output_parsed: flightAgentResultTemp.finalOutput
      };
    } else {
      const itineraryAgentResultTemp = await runner.run(
        itineraryAgent,
        [
          ...conversationHistory
        ]
      );
      conversationHistory.push(...itineraryAgentResultTemp.newItems.map((item) => item.rawItem));

      if (!itineraryAgentResultTemp.finalOutput) {
          throw new Error("Agent result is undefined");
      }

      const itineraryAgentResult = {
        output_text: itineraryAgentResultTemp.finalOutput ?? ""
      };
    }
  });
}
